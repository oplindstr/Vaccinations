// MongoDB Playground
// Use Ctrl+Space inside a snippet or a string literal to trigger completions.

// The current database to use.
use('Vaccinations');

// Search for documents in the current collection.

/*
db.order.aggregate(
  [
    {
      $lookup:
        {
          from: "vaccination",
          localField: "id",
          foreignField: "sourceBottle",
          as: "vaccination"
        }
    },
    {
      $unwind: {
        path: "$vaccination"
      }
    },
    {
      $match:
      { $and :
        [
          {"arrived" : { "$lt" : "2021-04-12T11:10:06.473587Z" }},
          {"vaccinationDate" : { "$lt" : "2021-04-12T11:10:06.473587Z" }} 
        ]
      }
    },
    {
      $count:"id"
    }
    
    {
      $project:
      {
        arrived: "$arrived",
        vaccinationDate: "$vaccination.vaccinationDate"
      }
    }
    
  ]
)
*/
db.order.aggregate(
  [
    { 
      $match: 
      { 
        $expr: 
        {
          $lt: 
          [ 
            "$arrived", 
            {
              $dateToString: 
              {
                date: {
                  $dateSubtract: {
                    startDate: { $toDate: "2021-04-12T11:10:06.473587Z" },
                    unit: "day",
                    amount: 30
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      $lookup:
        {
          from: "vaccination",
          localField: "id",
          foreignField: "sourceBottle",
          as: "vaccinations"
        }
    },
    {
      $project: 
      {
        vaccine: 1,
        injections: 1,
        vaccinations: 
        { 
          $filter: 
          { 
            input: "$vaccinations", 
            as: "vaccinations", 
            cond: 
            { 
              $lte: 
              [ 
                "$$vaccinations.vaccinationDate", 
                {
                  $dateToString: {
                    date: {
                        $dateAdd: {
                        startDate: { $toDate: "$arrived" },
                        unit: "day",
                        amount: 30
                      }
                    }
                  }
                } 
              ] 
            } 
          } 
        }
      }
    },
    {
      $group: {
        _id: "$vaccine",
        expired: { $sum: { $subtract: ["$injections", { $size: "$vaccinations" } ] } },
        done: {$sum: { $size: "$vaccinations" }},
        total: { $sum: "$injections" }
      }
    }
  ]
)

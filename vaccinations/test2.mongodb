// MongoDB Playground
// Use Ctrl+Space inside a snippet or a string literal to trigger completions.

// The current database to use.
use('Vaccinations');

// Search for documents in the current collection.

db.order.aggregate(
  [
    {
      $match:
      {  
        $expr: 
        { 
          $and: [
            {
              $lte: [ 
                "$arrived",
                {
                  $dateToString: 
                  {
                    date: {
                      $dateSubtract: 
                      {
                          startDate: { $toDate: "2021/04/12" },
                          unit: "day",
                          amount: 23
                      }
                    }
                  }
                }
              ]
            },
            {
              $gte: [ 
                "$arrived",
                {
                  $dateToString: 
                  {
                    date: {
                      $dateSubtract: 
                      {
                          startDate: { $toDate: "2021/04/12" },
                          unit: "day",
                          amount: 30
                      }
                    }
                  }
                }
              ]
            }
          ]
        } 
      }
    },
    {
      $sort:
      {
        arrived: 1
      }
    },
    {
      $lookup:
        {
          from: "vaccination",
          localField: "id",
          foreignField: "sourceBottle",
          as: "vaccinations"
        }
    },
    {
      $project: 
      {
        vaccine: 1,
        injections: 1,
        arrived: 1,
        vaccinations: 
        { 
          $filter: 
          { 
            input: "$vaccinations", 
            as: "vaccinations", 
            cond: 
            { 
              $lte: 
              [ 
                "$$vaccinations.vaccinationDate", 
                { $toDate: "2021/04/12" }
              ] 
            } 
          } 
        }
      }
    },
    {
      $group:
      {
        _id: "$vaccine",
        count: { $sum: { $subtract: ["$injections", { $size: "$vaccinations" } ] } }
      }
    }
  ]
)

/*
db.order.aggregate(
  [
    {
      $lookup:
        {
          from: "vaccination",
          localField: "id",
          foreignField: "sourceBottle",
          as: "vaccinations"
        }
    },
    {
      $project:
        {
          _id: 0,
          id: 1,
          orderNumber: 1,
          responsiblePerson: 1,
          healthCareDistrict: 1,
          vaccine: 1,
          injections: 1,
          arrived: 1,
          usedInjections: { $size: "$vaccinations" }
        }
    }
  ]
)
*/
